<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramen Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
        }
        .ramen-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .ramen-card:hover {
            transform: translateY(-5px);
        }
        .ramen-card.selected {
            transform: scale(1.05);
            box-shadow: 0 0 0 4px #fbbf24;
            border-color: #fbbf24;
        }
        .topping-checkbox:checked + label, .egg-radio:checked + label {
            transform: scale(1.05);
        }
        .topping-checkbox:checked + label { background-color: #f59e0b; color: white; border-color: #f59e0b; }
        .egg-radio:checked + label { background-color: #ea580c; color: white; border-color: #ea580c; }
        .timer-display { font-size: clamp(4rem, 20vw, 8rem); line-height: 1; }
        
        @keyframes pulse-attention {
          0%, 100% { transform: scale(1.05); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
          50% { transform: scale(1.08); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }
        .pulse-attention {
          animation: pulse-attention 1.5s ease-out;
        }
    </style>
</head>
<body class="bg-zinc-900 text-white antialiased">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="text-center my-6">
            <div class="flex justify-center mb-4">
                <select id="language-selector" class="bg-zinc-700 text-white rounded-lg p-2 appearance-none cursor-pointer">
                    <option value="ko">한국어</option>
                    <option value="en">English</option>
                    <option value="ja">日本語</option>
                    <option value="zh">中文</option>
                    <option value="es">Español</option>
                    <option value="de">Deutsch</option>
                    <option value="vi">Tiếng Việt</option>
                </select>
            </div>
            <h1 id="app-title" class="text-4xl font-bold text-amber-400">🍜 라면 타이머</h1>
            <p id="app-subtitle" class="text-zinc-400 mt-2">단계별로 따라하는 완벽한 라면 조리법</p>
        </header>

        <main class="lg:flex lg:gap-8">
            <!-- Left Column: Selections -->
            <div class="lg:w-1/2 space-y-8">
                <section id="ramen-selection" class="bg-zinc-800 p-6 rounded-2xl shadow-lg">
                    <h2 id="ramen-select-title" class="text-2xl font-bold mb-4 border-b-2 border-zinc-700 pb-2">1. 조리할 라면을 선택하세요</h2>
                    <div id="ramen-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                </section>

                <section id="topping-selection" class="bg-zinc-800 p-6 rounded-2xl shadow-lg hidden">
                    <h2 id="topping-select-title" class="text-2xl font-bold mb-4 border-b-2 border-zinc-700 pb-2">2. 추가할 토핑을 선택하세요</h2>
                    <div id="toppings" class="flex flex-wrap gap-3">
                        <div><input type="checkbox" id="topping-ricecake" class="hidden topping-checkbox" data-topping="ricecake"><label id="label-ricecake" for="topping-ricecake" class="cursor-pointer block text-center py-2 px-4 rounded-full border-2 border-zinc-600 transition-all">떡국떡 🍚</label></div>
                        <div><input type="checkbox" id="topping-scallion" class="hidden topping-checkbox" data-topping="scallion"><label id="label-scallion" for="topping-scallion" class="cursor-pointer block text-center py-2 px-4 rounded-full border-2 border-zinc-600 transition-all">파 🌿</label></div>
                        <div><input type="checkbox" id="topping-cheese" class="hidden topping-checkbox" data-topping="cheese"><label id="label-cheese" for="topping-cheese" class="cursor-pointer block text-center py-2 px-4 rounded-full border-2 border-zinc-600 transition-all">치즈 🧀</label></div>
                        <div><input type="checkbox" id="topping-egg" class="hidden topping-checkbox" data-topping="egg"><label id="label-egg" for="topping-egg" class="cursor-pointer block text-center py-2 px-4 rounded-full border-2 border-zinc-600 transition-all">계란 🥚</label></div>
                    </div>
                    <div id="egg-options" class="mt-4 p-4 bg-zinc-700/50 rounded-lg hidden">
                        <p id="egg-doneness-title" class="font-semibold mb-2">계란 익힘 정도:</p>
                        <div class="flex gap-3">
                            <div><input type="radio" id="egg-soft" name="egg-type" value="soft" class="hidden egg-radio" checked><label id="label-soft-egg" for="egg-soft" class="cursor-pointer block text-center py-2 px-4 rounded-full border-2 border-zinc-500 transition-all">반숙</label></div>
                            <div><input type="radio" id="egg-hard" name="egg-type" value="hard" class="hidden egg-radio"><label id="label-hard-egg" for="egg-hard" class="cursor-pointer block text-center py-2 px-4 rounded-full border-2 border-zinc-500 transition-all">완숙</label></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Timer & Status -->
            <div class="lg:w-1/2 mt-8 lg:mt-0">
                <div class="lg:sticky lg:top-8">
                     <section id="cooking-guide-section" class="bg-zinc-800 p-6 rounded-2xl shadow-lg text-center hidden">
                        <h2 id="recipe-title" class="text-2xl font-bold mb-2 text-amber-400"></h2>
                        <div id="timer-display" class="timer-display font-mono font-bold my-4 text-zinc-100"></div>
                        <div class="bg-zinc-900 p-4 rounded-lg min-h-[80px] flex items-center justify-center">
                            <p id="current-instruction" class="text-xl text-amber-300 font-semibold"></p>
                        </div>
                        
                        <div class="flex justify-center gap-4 mt-6">
                            <button id="action-btn" class="bg-amber-500 hover:bg-amber-600 text-zinc-900 font-bold py-3 px-8 rounded-full text-xl transition-all transform hover:scale-105 w-40">시작</button>
                            <button id="next-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-all transform w-40">다음 단계</button>
                            <button id="reset-btn" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-3 px-8 rounded-full text-xl transition-all transform hover:scale-105">초기화</button>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <footer class="text-center mt-10 pb-6">
            <p class="text-sm text-zinc-500">Developed by 가치있는미래교육연구소 대표 김병찬</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <script>
    const translations = {
        ko: {
            // UI
            "app-title": "🍜 라면 타이머", "app-subtitle": "단계별로 따라하는 완벽한 라면 조리법",
            "ramen-select-title": "1. 조리할 라면을 선택하세요", "topping-select-title": "2. 추가할 토핑을 선택하세요",
            "label-ricecake": "떡국떡 🍚", "label-scallion": "파 🌿", "label-cheese": "치즈 🧀", "label-egg": "계란 🥚",
            "egg-doneness-title": "계란 익힘 정도:", "label-soft-egg": "반숙", "label-hard-egg": "완숙",
            "action-btn-start": "시작", "action-btn-cooking": "조리 중...", "next-btn": "다음 단계", "reset-btn": "초기화",
            "button-complete": "완료",
            
            // Ramen Names
            shin: '신라면', neoguri: '너구리', ansung: '안성탕면', jin: '진라면', samyang: '삼양라면',
            jjapagetti: '짜파게티', buldak: '불닭볶음면', bibim: '비빔면', wang: '왕뚜껑',
            
            // Recipes
            cook_boil_water: (water) => `물 ${water}ml를 끓여주세요.`,
            cook_add_noodles_soup: '면과 스프를 넣고 끓여주세요.',
            cook_add_noodles_flakes: '면과 후레이크를 넣고 끓여주세요.',
            cook_add_noodles: '면을 넣고 끓여주세요.',
            cook_drain_water: '물 8스푼을 남기고 버린 후, 스프를 넣어주세요.',
            cook_drain_water_some: '물을 약간 남기고 버린 후, 소스를 넣어주세요.',
            cook_stir_fry: '약한 불에서 비벼주며 볶아주세요.',
            cook_rinse_noodles: '찬물에 면을 헹구고 물기를 빼주세요.',
            cook_mix_sauce: '소스와 비벼 맛있게 드세요!',
            cook_pour_hot_water: (water) => `${water}까지 뜨거운 물을 부어주세요.`,
            cook_wait_3_min: '3분간 기다려주세요.',
            
            // Toppings & Finish
            topping_add_ricecake: '떡을 지금 넣어주세요! 🍚',
            topping_add_egg: (type) => `계란(${type})을 넣어주세요! 🥚`,
            topping_egg_hard: '완숙', topping_egg_soft: '반숙',
            topping_add_scallion: '파를 지금 넣어주세요! 🌿',
            finish_add_cheese: '불을 끄고 치즈를 올려주세요! 🧀',
            finish_enjoy: '완성! 맛있게 드세요! 😋'
        },
        en: {
            "app-title": "🍜 Ramen Timer", "app-subtitle": "The perfect step-by-step ramen guide",
            "ramen-select-title": "1. Select your ramen", "topping-select-title": "2. Choose your toppings",
            "label-ricecake": "Rice Cake 🍚", "label-scallion": "Scallion 🌿", "label-cheese": "Cheese 🧀", "label-egg": "Egg 🥚",
            "egg-doneness-title": "Egg doneness:", "label-soft-egg": "Soft-boiled", "label-hard-egg": "Hard-boiled",
            "action-btn-start": "Start", "action-btn-cooking": "Cooking...", "next-btn": "Next Step", "reset-btn": "Reset",
            "button-complete": "Complete",
            
            shin: 'Shin Ramyun', neoguri: 'Neoguri', ansung: 'Ansungtangmyun', jin: 'Jin Ramen', samyang: 'Samyang Ramen',
            jjapagetti: 'Jjapagetti', buldak: 'Buldak Ramen', bibim: 'Bibim Men', wang: 'Wang Ttukkeong',
            
            cook_boil_water: (water) => `Boil ${water}ml of water.`,
            cook_add_noodles_soup: 'Add noodles and soup base, then boil.',
            cook_add_noodles_flakes: 'Add noodles and flakes, then boil.',
            cook_add_noodles: 'Add noodles and boil.',
            cook_drain_water: 'Leave 8 spoons of water, drain the rest, and add powder soup.',
            cook_drain_water_some: 'Leave a little water, drain the rest, and add sauce.',
            cook_stir_fry: 'Stir-fry on low heat.',
            cook_rinse_noodles: 'Rinse noodles in cold water and drain.',
            cook_mix_sauce: 'Mix with sauce and enjoy!',
            cook_pour_hot_water: (water) => `Pour hot water up to the ${water}.`,
            cook_wait_3_min: 'Wait for 3 minutes.',
            
            topping_add_ricecake: 'Add rice cakes now! 🍚',
            topping_add_egg: (type) => `Add ${type} egg now! 🥚`,
            topping_egg_hard: 'hard-boiled', topping_egg_soft: 'soft-boiled',
            topping_add_scallion: 'Add scallions now! 🌿',
            finish_add_cheese: 'Turn off heat and add cheese! 🧀',
            finish_enjoy: 'Done! Enjoy your meal! 😋'
        },
        ja: {
            "app-title": "🍜 ラーメンタイマー", "app-subtitle": "ステップバイステップで完璧なラーメン作り",
            "ramen-select-title": "1. ラーメンを選んでください", "topping-select-title": "2. トッピングを選んでください",
            "label-ricecake": "トック 🍚", "label-scallion": "ネギ 🌿", "label-cheese": "チーズ 🧀", "label-egg": "卵 🥚",
            "egg-doneness-title": "卵の固さ:", "label-soft-egg": "半熟", "label-hard-egg": "固ゆで",
            "action-btn-start": "スタート", "action-btn-cooking": "調理中...", "next-btn": "次のステップ", "reset-btn": "リセット",
            "button-complete": "完了",

            shin: '辛ラーメン', neoguri: 'ノグリ', ansung: '安城湯麺', jin: 'ジンラーメン', samyang: '三養ラーメン',
            jjapagetti: 'チャパゲティ', buldak: 'ブルダック炒め麺', bibim: 'ビビン麺', wang: '王様のフタ',
            
            cook_boil_water: (water) => `水${water}mlを沸かしてください。`,
            cook_add_noodles_soup: '麺とスープを入れて煮込みます。',
            cook_add_noodles_flakes: '麺とフレークを入れて煮込みます。',
            cook_add_noodles: '麺を入れて煮込みます。',
            cook_drain_water: 'お湯を大さじ8杯残して捨て、粉末スープを入れます。',
            cook_drain_water_some: 'お湯を少し残して捨て、ソースを入れます。',
            cook_stir_fry: '弱火で混ぜながら炒めます。',
            cook_rinse_noodles: '麺を冷水ですすぎ、水気を切ります。',
            cook_mix_sauce: 'ソースと混ぜてお召し上がりください！',
            cook_pour_hot_water: (water) => `${water}までお湯を注いでください。`,
            cook_wait_3_min: '3分間待ちます。',

            topping_add_ricecake: '今すぐトックを入れてください！ 🍚',
            topping_add_egg: (type) => `今すぐ${type}卵を入れてください！ 🥚`,
            topping_egg_hard: '固ゆで', topping_egg_soft: '半熟',
            topping_add_scallion: '今すぐネギを入れてください！ 🌿',
            finish_add_cheese: '火を止めてチーズをのせてください！ 🧀',
            finish_enjoy: '完成！美味しく召し上がれ！ 😋'
        },
        zh: {
            "app-title": "🍜 拉面计时器", "app-subtitle": "分步完美的拉面指南",
            "ramen-select-title": "1. 选择您的拉面", "topping-select-title": "2. 选择您的配料",
            "label-ricecake": "年糕 🍚", "label-scallion": "葱 🌿", "label-cheese": "芝士 🧀", "label-egg": "鸡蛋 🥚",
            "egg-doneness-title": "鸡蛋熟度:", "label-soft-egg": "溏心", "label-hard-egg": "全熟",
            "action-btn-start": "开始", "action-btn-cooking": "烹饪中...", "next-btn": "下一步", "reset-btn": "重置",
            "button-complete": "完成",

            shin: '辛拉面', neoguri: '乌冬面', ansung: '安城汤面', jin: '真拉面', samyang: '三养拉面',
            jjapagetti: '炸酱面', buldak: '火鸡面', bibim: '拌面', wang: '王盖拉面',

            cook_boil_water: (water) => `烧开${water}毫升水。`,
            cook_add_noodles_soup: '加入面条和汤料，然后煮沸。',
            cook_add_noodles_flakes: '加入面条和蔬菜包，然后煮沸。',
            cook_add_noodles: '加入面条煮沸。',
            cook_drain_water: '保留8勺水，倒掉其余的水，然后加入粉状汤料。',
            cook_drain_water_some: '保留少量水，倒掉其余的水，然后加入酱汁。',
            cook_stir_fry: '用小火翻炒。',
            cook_rinse_noodles: '用冷水冲洗面条并沥干。',
            cook_mix_sauce: '与酱汁混合即可享用！',
            cook_pour_hot_water: (water) => `加热水至${water}。`,
            cook_wait_3_min: '等待3分钟。',

            topping_add_ricecake: '现在加入年糕！ 🍚',
            topping_add_egg: (type) => `现在加入${type}鸡蛋！ 🥚`,
            topping_egg_hard: '全熟', topping_egg_soft: '溏心',
            topping_add_scallion: '现在加入葱！ 🌿',
            finish_add_cheese: '关火并加入芝士！ 🧀',
            finish_enjoy: '完成！请享用！ 😋'
        },
        es: {
            "app-title": "🍜 Temporizador de Ramen", "app-subtitle": "La guía perfecta de ramen paso a paso",
            "ramen-select-title": "1. Selecciona tu ramen", "topping-select-title": "2. Elige tus toppings",
            "label-ricecake": "Pastel de arroz 🍚", "label-scallion": "Cebolleta 🌿", "label-cheese": "Queso 🧀", "label-egg": "Huevo 🥚",
            "egg-doneness-title": "Cocción del huevo:", "label-soft-egg": "Pasado por agua", "label-hard-egg": "Huevo duro",
            "action-btn-start": "Empezar", "action-btn-cooking": "Cocinando...", "next-btn": "Siguiente", "reset-btn": "Reiniciar",
            "button-complete": "Completar",

            shin: 'Shin Ramyun', neoguri: 'Neoguri', ansung: 'Ansungtangmyun', jin: 'Jin Ramen', samyang: 'Samyang Ramen',
            jjapagetti: 'Jjapagetti', buldak: 'Buldak Ramen', bibim: 'Bibim Men', wang: 'Wang Ttukkeong',
            
            cook_boil_water: (water) => `Hervir ${water}ml de agua.`,
            cook_add_noodles_soup: 'Añadir fideos y base de sopa, luego hervir.',
            cook_add_noodles_flakes: 'Añadir fideos y copos, luego hervir.',
            cook_add_noodles: 'Añadir fideos y hervir.',
            cook_drain_water: 'Dejar 8 cucharadas de agua, escurrir el resto y añadir la sopa en polvo.',
            cook_drain_water_some: 'Dejar un poco de agua, escurrir el resto y añadir la salsa.',
            cook_stir_fry: 'Saltear a fuego lento.',
            cook_rinse_noodles: 'Enjuagar los fideos en agua fría y escurrir.',
            cook_mix_sauce: '¡Mezclar con la salsa y disfrutar!',
            cook_pour_hot_water: (water) => `Verter agua caliente hasta la ${water}.`,
            cook_wait_3_min: 'Esperar 3 minutos.',

            topping_add_ricecake: '¡Añade los pasteles de arroz ahora! 🍚',
            topping_add_egg: (type) => `¡Añade el huevo ${type} ahora! 🥚`,
            topping_egg_hard: 'duro', topping_egg_soft: 'pasado por agua',
            topping_add_scallion: '¡Añade las cebolletas ahora! 🌿',
            finish_add_cheese: '¡Apaga el fuego y añade el queso! 🧀',
            finish_enjoy: '¡Listo! ¡Buen provecho! 😋'
        },
        de: {
            "app-title": "🍜 Ramen-Timer", "app-subtitle": "Die perfekte Schritt-für-Schritt-Anleitung für Ramen",
            "ramen-select-title": "1. Wähle dein Ramen", "topping-select-title": "2. Wähle deine Toppings",
            "label-ricecake": "Reiskuchen 🍚", "label-scallion": "Frühlingszwiebel 🌿", "label-cheese": "Käse 🧀", "label-egg": "Ei 🥚",
            "egg-doneness-title": "Ei-Garstufe:", "label-soft-egg": "Weich gekocht", "label-hard-egg": "Hart gekocht",
            "action-btn-start": "Start", "action-btn-cooking": "Kochen...", "next-btn": "Nächster Schritt", "reset-btn": "Zurücksetzen",
            "button-complete": "Abschließen",

            shin: 'Shin Ramyun', neoguri: 'Neoguri', ansung: 'Ansungtangmyun', jin: 'Jin Ramen', samyang: 'Samyang Ramen',
            jjapagetti: 'Jjapagetti', buldak: 'Buldak Ramen', bibim: 'Bibim Men', wang: 'Wang Ttukkeong',
            
            cook_boil_water: (water) => `${water}ml Wasser kochen.`,
            cook_add_noodles_soup: 'Nudeln und Suppenbasis hinzufügen, dann kochen.',
            cook_add_noodles_flakes: 'Nudeln und Flocken hinzufügen, dann kochen.',
            cook_add_noodles: 'Nudeln hinzufügen und kochen.',
            cook_drain_water: '8 Löffel Wasser übrig lassen, den Rest abgießen und die Pulversuppe hinzufügen.',
            cook_drain_water_some: 'Ein wenig Wasser übrig lassen, den Rest abgießen und die Soße hinzufügen.',
            cook_stir_fry: 'Bei schwacher Hitze unter Rühren braten.',
            cook_rinse_noodles: 'Nudeln in kaltem Wasser abspülen und abtropfen lassen.',
            cook_mix_sauce: 'Mit Soße mischen und genießen!',
            cook_pour_hot_water: (water) => `Heißes Wasser bis zur ${water} eingießen.`,
            cook_wait_3_min: '3 Minuten warten.',

            topping_add_ricecake: 'Jetzt Reiskuchen hinzufügen! 🍚',
            topping_add_egg: (type) => `Jetzt ${type} Ei hinzufügen! 🥚`,
            topping_egg_hard: 'hart gekochtes', topping_egg_soft: 'weich gekochtes',
            topping_add_scallion: 'Jetzt Frühlingszwiebeln hinzufügen! 🌿',
            finish_add_cheese: 'Hitze ausschalten und Käse hinzufügen! 🧀',
            finish_enjoy: 'Fertig! Guten Appetit! 😋'
        },
        vi: {
            "app-title": "🍜 Đồng hồ bấm giờ Ramen", "app-subtitle": "Hướng dẫn nấu mì ramen hoàn hảo từng bước",
            "ramen-select-title": "1. Chọn loại mì ramen của bạn", "topping-select-title": "2. Chọn topping của bạn",
            "label-ricecake": "Bánh gạo 🍚", "label-scallion": "Hành lá 🌿", "label-cheese": "Phô mai 🧀", "label-egg": "Trứng 🥚",
            "egg-doneness-title": "Độ chín của trứng:", "label-soft-egg": "Lòng đào", "label-hard-egg": "Chín kỹ",
            "action-btn-start": "Bắt đầu", "action-btn-cooking": "Đang nấu...", "next-btn": "Bước tiếp theo", "reset-btn": "Đặt lại",
            "button-complete": "Hoàn thành",

            shin: 'Mì Shin', neoguri: 'Mì Neoguri', ansung: 'Mì Ansungtangmyun', jin: 'Mì Jin', samyang: 'Mì Samyang',
            jjapagetti: 'Mì Jjapagetti', buldak: 'Mì cay Buldak', bibim: 'Mì trộn Bibim', wang: 'Mì Wang Ttukkeong',

            cook_boil_water: (water) => `Đun sôi ${water}ml nước.`,
            cook_add_noodles_soup: 'Cho mì và gói súp vào, sau đó đun sôi.',
            cook_add_noodles_flakes: 'Cho mì và gói rau vào, sau đó đun sôi.',
            cook_add_noodles: 'Cho mì vào và đun sôi.',
            cook_drain_water: 'Để lại 8 muỗng nước, đổ phần còn lại và cho gói súp bột vào.',
            cook_drain_water_some: 'Để lại một ít nước, đổ phần còn lại và cho sốt vào.',
            cook_stir_fry: 'Xào trên lửa nhỏ.',
            cook_rinse_noodles: 'Rửa mì trong nước lạnh và để ráo.',
            cook_mix_sauce: 'Trộn với sốt và thưởng thức!',
            cook_pour_hot_water: (water) => `Đổ nước nóng đến ${water}.`,
            cook_wait_3_min: 'Đợi trong 3 phút.',

            topping_add_ricecake: 'Bây giờ cho bánh gạo vào! 🍚',
            topping_add_egg: (type) => `Bây giờ cho trứng ${type} vào! 🥚`,
            topping_egg_hard: 'chín kỹ', topping_egg_soft: 'lòng đào',
            topping_add_scallion: 'Bây giờ cho hành lá vào! 🌿',
            finish_add_cheese: 'Tắt bếp và cho phô mai vào! 🧀',
            finish_enjoy: 'Xong! Chúc bạn ngon miệng! 😋'
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // --- State Variables ---
        let selectedRamen = null;
        let timerInterval = null;
        let remainingTime = 0;
        let synth;
        let audioInitialized = false;
        let cookingSteps = [];
        let currentStepIndex = 0;
        let currentLang = 'ko';

        // --- UI Elements ---
        const langSelector = document.getElementById('language-selector');
        const ramenListEl = document.getElementById('ramen-list');
        const toppingSectionEl = document.getElementById('topping-selection');
        const cookingGuideSectionEl = document.getElementById('cooking-guide-section');
        const recipeTitleEl = document.getElementById('recipe-title');
        const timerDisplayEl = document.getElementById('timer-display');
        const currentInstructionEl = document.getElementById('current-instruction');
        const actionBtnEl = document.getElementById('action-btn');
        const nextBtnEl = document.getElementById('next-btn');
        const resetBtnEl = document.getElementById('reset-btn');
        const eggCheckbox = document.getElementById('topping-egg');
        const eggOptionsEl = document.getElementById('egg-options');

        const langVoiceMap = {
            ko: 'ko-KR', en: 'en-US', ja: 'ja-JP', zh: 'zh-CN',
            es: 'es-ES', de: 'de-DE', vi: 'vi-VN'
        };

        const ramenRecipes = {
            shin: { water: 550, img: '🍜', cookTime: 270 },
            neoguri: { water: 550, img: '🍲', cookTime: 300 },
            ansung: { water: 550, img: '🍜', cookTime: 270 },
            jin: { water: 550, img: '🍲', cookTime: 240 },
            samyang: { water: 550, img: '🍜', cookTime: 240 },
            jjapagetti: {
                water: 600, img: '🍝', type: 'special', steps: [
                    { instruction: 'cook_boil_water', duration: 0, button: 'button-next' },
                    { instruction: 'cook_add_noodles_flakes', duration: 300 },
                    { instruction: 'cook_drain_water', duration: 0, button: 'button-next' },
                    { instruction: 'cook_stir_fry', duration: 60 },
                    { instruction: 'finish_enjoy', duration: 0, button: 'button-complete' }
                ]
            },
            buldak: {
                water: 600, img: '🌶️', type: 'special', steps: [
                    { instruction: 'cook_boil_water', duration: 0, button: 'button-next' },
                    { instruction: 'cook_add_noodles', duration: 300 },
                    { instruction: 'cook_drain_water_some', duration: 0, button: 'button-next' },
                    { instruction: 'cook_stir_fry', duration: 30 },
                    { instruction: 'finish_enjoy', duration: 0, button: 'button-complete' }
                ]
            },
            bibim: {
                water: 600, img: '🥗', type: 'special', steps: [
                    { instruction: 'cook_boil_water', duration: 0, button: 'button-next' },
                    { instruction: 'cook_add_noodles', duration: 180 },
                    { instruction: 'cook_rinse_noodles', duration: 0, button: 'button-next' },
                    { instruction: 'cook_mix_sauce', duration: 0, button: 'button-complete' }
                ]
            },
            wang: {
                water: 'line inside', img: '👑', type: 'special', steps: [
                    { instruction: 'cook_pour_hot_water', duration: 0, button: 'button-next' },
                    { instruction: 'cook_wait_3_min', duration: 180 },
                    { instruction: 'finish_enjoy', duration: 0, button: 'button-complete' }
                ]
            }
        };

        // --- Audio ---
        async function initializeAudio() {
            if (audioInitialized || typeof Tone === 'undefined') return;
            try {
                await Tone.start();
                synth = new Tone.Synth().toDestination();
                audioInitialized = true;
            } catch (e) { console.error("Could not initialize audio:", e); }
        }

        function removeEmojis(text) {
            if (!text) return '';
            // This regex covers a wide range of emojis
            return text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
        }

        function speak(text) {
            if (!'speechSynthesis' in window) return;
            const textWithoutEmojis = removeEmojis(text);
            speechSynthesis.cancel(); // Stop any previous speech
            const utterance = new SpeechSynthesisUtterance(textWithoutEmojis);
            utterance.lang = langVoiceMap[currentLang];
            speechSynthesis.speak(utterance);
        }

        // --- Language & Translation ---
        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            const langTrans = translations[lang];

            document.getElementById('app-title').textContent = langTrans['app-title'];
            document.getElementById('app-subtitle').textContent = langTrans['app-subtitle'];
            document.getElementById('ramen-select-title').textContent = langTrans['ramen-select-title'];
            document.getElementById('topping-select-title').textContent = langTrans['topping-select-title'];
            document.getElementById('label-ricecake').textContent = langTrans['label-ricecake'];
            document.getElementById('label-scallion').textContent = langTrans['label-scallion'];
            document.getElementById('label-cheese').textContent = langTrans['label-cheese'];
            document.getElementById('label-egg').textContent = langTrans['label-egg'];
            document.getElementById('egg-doneness-title').textContent = langTrans['egg-doneness-title'];
            document.getElementById('label-soft-egg').textContent = langTrans['label-soft-egg'];
            document.getElementById('label-hard-egg').textContent = langTrans['label-hard-egg'];
            document.getElementById('reset-btn').textContent = langTrans['reset-btn'];

            renderRamenCards();
            if (selectedRamen) {
                recipeTitleEl.textContent = langTrans[selectedRamen];
                generateSteps();
                resetState();
            } else {
                renderCurrentStep();
            }
        }
        
        // --- UI Rendering ---
        function renderRamenCards() {
            ramenListEl.innerHTML = '';
            const langTrans = translations[currentLang];
            Object.keys(ramenRecipes).forEach(id => {
                const recipe = ramenRecipes[id];
                const card = document.createElement('div');
                card.className = 'ramen-card cursor-pointer bg-zinc-700 p-4 rounded-lg text-center';
                card.dataset.ramenId = id;
                card.innerHTML = `<div class="text-4xl mb-2">${recipe.img}</div><span class="font-semibold">${langTrans[id]}</span>`;
                card.addEventListener('click', () => selectRamen(id));
                if (id === selectedRamen) card.classList.add('selected');
                ramenListEl.appendChild(card);
            });
        }

        function renderCurrentStep() {
            nextBtnEl.classList.remove('pulse-attention');
            const langTrans = translations[currentLang];

            if (!selectedRamen) {
                currentInstructionEl.textContent = '';
                timerDisplayEl.textContent = '';
                actionBtnEl.style.display = 'none';
                nextBtnEl.style.display = 'none';
                return;
            }

            const step = cookingSteps[currentStepIndex];

            if (!step) {
                actionBtnEl.style.display = 'none';
                nextBtnEl.style.display = 'inline-block';
                nextBtnEl.disabled = true;
                nextBtnEl.textContent = langTrans['button-complete'];
                return;
            }
            
            const instructionTemplate = langTrans[step.instruction];
            let waterAmount = ramenRecipes[selectedRamen].water;
            if (currentLang !== 'ko' && waterAmount === '용기 안쪽 선') waterAmount = 'line inside';

            let instructionText = typeof instructionTemplate === 'function' ? instructionTemplate(waterAmount) : instructionTemplate;
            
            currentInstructionEl.textContent = instructionText;
            speak(instructionText);

            nextBtnEl.style.display = 'inline-block'; // Always show next button during steps
            nextBtnEl.disabled = false;

            if (step.duration > 0) {
                remainingTime = step.duration;
                timerDisplayEl.textContent = formatTime(remainingTime);
                actionBtnEl.textContent = langTrans['action-btn-start'];
                actionBtnEl.disabled = false;
                actionBtnEl.style.display = 'inline-block';
                nextBtnEl.textContent = langTrans['next-btn'];
            } else {
                timerDisplayEl.textContent = '';
                actionBtnEl.style.display = 'none';
                if (step.button === 'button-complete') {
                    nextBtnEl.textContent = langTrans['button-complete'];
                } else {
                    nextBtnEl.textContent = langTrans['next-btn'];
                }
                setTimeout(() => nextBtnEl.classList.add('pulse-attention'), 100);
            }
        }

        // --- Event Handlers ---
        langSelector.addEventListener('change', (e) => setLanguage(e.target.value));

        function selectRamen(id) {
            selectedRamen = id;
            renderRamenCards();
            
            recipeTitleEl.textContent = translations[currentLang][id];
            generateSteps();
            resetState();

            toppingSectionEl.classList.remove('hidden');
            cookingGuideSectionEl.classList.remove('hidden');

            if (window.innerWidth < 1024) { // lg breakpoint
                cookingGuideSectionEl.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        actionBtnEl.addEventListener('click', () => {
            initializeAudio();
            const step = cookingSteps[currentStepIndex];
            if (step && step.duration > 0 && !timerInterval) {
                startTimer();
            }
        });

        nextBtnEl.addEventListener('click', () => {
            const step = cookingSteps[currentStepIndex];
            if(!step || step.button === 'button-complete') return;
            
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            proceedToNextStep();
        });

        resetBtnEl.addEventListener('click', () => {
            if (selectedRamen) {
                generateSteps();
                resetState();
            }
        });

        document.querySelectorAll('#topping-selection input').forEach(input => {
            input.addEventListener('change', () => {
                if (selectedRamen) {
                    generateSteps();
                    resetState();
                }
            });
        });
        
        eggCheckbox.addEventListener('change', (e) => {
            eggOptionsEl.classList.toggle('hidden', !e.target.checked);
        });

        // --- Logic ---
        function generateSteps() {
            const recipe = ramenRecipes[selectedRamen];
            const toppings = getSelectedToppings();

            if (recipe.type === 'special') {
                cookingSteps = [...recipe.steps]; // Create a copy
                return;
            }
            
            let steps = [
                { instruction: 'cook_boil_water', duration: 0, button: 'button-next' },
                { instruction: 'cook_add_noodles_soup', duration: recipe.cookTime, isCookingStep: true }
            ];

            let finalInstruction = toppings.cheese ? 'finish_add_cheese' : 'finish_enjoy';
            steps.push({ instruction: finalInstruction, duration: 0, button: 'button-complete' });
            
            let cookingStep = steps.find(s => s.isCookingStep);
            if (cookingStep) {
                cookingStep.subSteps = [];
                const langTrans = translations[currentLang];
                if(toppings.ricecake) cookingStep.subSteps.push({ time: cookingStep.duration - 10, instruction: langTrans.topping_add_ricecake });
                if(toppings.egg) {
                    const eggTime = toppings.eggType === 'hard' ? 210 : 90;
                    if(cookingStep.duration >= eggTime) {
                        const eggTypeText = langTrans[`topping_egg_${toppings.eggType}`];
                        cookingStep.subSteps.push({ time: eggTime, instruction: langTrans.topping_add_egg(eggTypeText) });
                    }
                }
                if(toppings.scallion) cookingStep.subSteps.push({ time: 30, instruction: langTrans.topping_add_scallion });
                cookingStep.subSteps.sort((a,b) => b.time - a.time);
            }

            cookingSteps = steps;
        }

        function proceedToNextStep() {
            playNotificationSound();
            currentStepIndex++;
            renderCurrentStep();
        }

        function startTimer() {
            const subSteps = [...(cookingSteps[currentStepIndex]?.subSteps || [])];
            const langTrans = translations[currentLang];

            actionBtnEl.textContent = langTrans['action-btn-cooking'];
            actionBtnEl.disabled = true;

            timerInterval = setInterval(() => {
                remainingTime--;
                timerDisplayEl.textContent = formatTime(remainingTime);

                if (subSteps.length > 0 && remainingTime === subSteps[0].time) {
                    const subInstruction = subSteps[0].instruction;
                    currentInstructionEl.textContent = subInstruction;
                    speak(subInstruction);
                    playNotificationSound();
                    subSteps.shift();
                }

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    actionBtnEl.style.display = 'none';
                    
                    const nextStep = cookingSteps[currentStepIndex + 1];
                    if (nextStep) {
                        const nextStepKey = nextStep.instruction;
                        const nextStepTemplate = translations[currentLang][nextStepKey];
                        const nextStepText = typeof nextStepTemplate === 'function' ? nextStepTemplate(ramenRecipes[selectedRamen].water) : nextStepTemplate;
                        speak(nextStepText);
                        setTimeout(() => nextBtnEl.classList.add('pulse-attention'), 100);
                    }
                }
            }, 1000);
        }

        function resetState() {
            clearInterval(timerInterval);
            timerInterval = null;
            speechSynthesis.cancel();
            currentStepIndex = 0;
            renderCurrentStep();
        }
        
        function getSelectedToppings() {
            return {
                ricecake: document.getElementById('topping-ricecake').checked,
                scallion: document.getElementById('topping-scallion').checked,
                cheese: document.getElementById('topping-cheese').checked,
                egg: document.getElementById('topping-egg').checked,
                eggType: document.querySelector('input[name="egg-type"]:checked').value
            };
        }

        // --- Utility ---
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function playNotificationSound() {
            if (audioInitialized && synth) {
                synth.triggerAttackRelease("C5", "8n", Tone.now());
            }
        }

        // --- Initial Load ---
        setLanguage('ko');
    });
    </script>
</body>
</html>

